@model JC.Productos.EN.Venta

@{
    ViewData["Title"] = "Registrar Venta";
}

<h1>Registrar Nueva Venta</h1>

<hr />
<div class="row">
    <div class="col-md-12">
        <form asp-action="Create">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="form-group">
                <label asp-for="ClienteId" class="control-label">Cliente</label>
                <select asp-for="ClienteId" class="form-control" asp-items="ViewBag.Clientes"></select>
                <span asp-validation-for="ClienteId" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label class="control-label">Productos</label>
                <table class="table" id="tblProductos">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>SubTotal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Aquí se agregarán dinámicamente los productos -->
                    </tbody>
                </table>
                <button type="button" class="btn btn-secondary" id="btnAgregarProducto">Agregar Producto</button>
            </div>

            <div class="form-group">
                <label asp-for="Total" class="control-label"></label>
                <input asp-for="Total" class="form-control" readonly />
                <span asp-validation-for="Total" class="text-danger"></span>
            </div>

            <div class="form-group">
                <input type="submit" value="Guardar" class="btn btn-primary" />
                <a asp-action="Index" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function() {
            var productos = @Html.Raw(Json.Serialize(ViewBag.Productos));
            var detalles = [];

            $("#btnAgregarProducto").click(function() {
                var html = `
                    <tr>
                        <td>
                            <select class="form-control producto" onchange="actualizarPrecio(this)">
                                <option value="">Seleccione un producto</option>
                                ${productos.map(p => `<option value="${p.id}" data-precio="${p.precio}">${p.nombre}</option>`).join('')}
                            </select>
                        </td>
                        <td><input type="number" class="form-control cantidad" min="1" value="1" onchange="calcularSubTotal(this)"></td>
                        <td><input type="number" class="form-control precio" readonly></td>
                        <td><input type="number" class="form-control subtotal" readonly></td>
                        <td><button type="button" class="btn btn-danger" onclick="eliminarFila(this)">Eliminar</button></td>
                    </tr>
                `;
                $("#tblProductos tbody").append(html);
            });

            window.actualizarPrecio = function(select) {
                var precio = $(select).find('option:selected').data('precio');
                $(select).closest('tr').find('.precio').val(precio);
                calcularSubTotal(select);
            };

            window.calcularSubTotal = function(input) {
                var row = $(input).closest('tr');
                var cantidad = parseFloat(row.find('.cantidad').val()) || 0;
                var precio = parseFloat(row.find('.precio').val()) || 0;
                var subtotal = cantidad * precio;
                row.find('.subtotal').val(subtotal.toFixed(2));
                calcularTotal();
            };

            window.calcularTotal = function() {
                var total = 0;
                $('.subtotal').each(function() {
                    total += parseFloat($(this).val()) || 0;
                });
                $('#Total').val(total.toFixed(2));
            };

            window.eliminarFila = function(button) {
                $(button).closest('tr').remove();
                calcularTotal();
            };
        });
    </script>
}
